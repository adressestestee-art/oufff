// ... (code HTML et CSS précédent) ...

<script>
    emailjs.init("mxm3fFA_BxEhqJieq");

    const video = document.getElementById('video');
    const photoPreview = document.getElementById('photo-preview');
    const startCameraBtn = document.getElementById('start-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const sendBtn = document.getElementById('send-btn');
    const resetBtn = document.getElementById('reset-btn');
    const message = document.getElementById('message');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    let videoStream = null;

    startCameraBtn.addEventListener('click', async () => {
        message.textContent = "Demande d'accès à la caméra...";
        startCameraBtn.disabled = true;

        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = videoStream;
            video.style.display = 'block';

            startCameraBtn.style.display = 'none';
            captureBtn.style.display = 'inline-block';
            resetBtn.style.display = 'inline-block';
            message.textContent = "Caméra active. Prenez une photo quand vous êtes prêt.";
        } catch (err) {
            message.textContent = "❌ Erreur d'accès à la caméra. Veuillez autoriser l'accès.";
            console.error("Erreur d'accès à la caméra :", err);
            startCameraBtn.disabled = false;
        }
    });

    captureBtn.addEventListener('click', () => {
        if (!videoStream) {
            message.textContent = "Erreur: La caméra n'est pas active.";
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Arrêter le flux vidéo pour respecter la vie privée de l'utilisateur
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;

        const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
        photoPreview.src = imageDataURL;
        photoPreview.style.display = 'block';
        video.style.display = 'none';

        captureBtn.style.display = 'none';
        sendBtn.style.display = 'inline-block';
        message.textContent = "Photo prise avec succès. Vous pouvez l'envoyer ou recommencer.";
    });

    sendBtn.addEventListener('click', () => {
        message.textContent = "Envoi en cours...";
        sendBtn.disabled = true;
        resetBtn.disabled = true;

        const imageDataURL = photoPreview.src;
        
        // Envoi de la photo comme un fichier joint
        const templateParams = {
            name: "Utilisateur anonyme",
            time: new Date().toLocaleString(),
            message: "Photo volontaire",
            image_as_attachment: imageDataURL
        };

        emailjs.send("service_8cs0gml", "template_w14xn7c", templateParams)
        .then(() => {
            message.textContent = "✅ Photo envoyée avec succès !";
        })
        .catch(err => {
            message.textContent = "❌ Erreur lors de l'envoi. Veuillez vérifier vos paramètres.";
            console.error("Erreur d'envoi EmailJS:", err);
        })
        .finally(() => {
            sendBtn.disabled = false;
            resetBtn.disabled = false;
        });
    });

    resetBtn.addEventListener('click', () => {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        video.style.display = 'none';
        photoPreview.style.display = 'none';
        captureBtn.style.display = 'none';
        sendBtn.style.display = 'none';
        resetBtn.style.display = 'none';
        
        startCameraBtn.style.display = 'inline-block';
        startCameraBtn.disabled = false;
        
        message.textContent = "Prêt à commencer.";
    });
</script>
